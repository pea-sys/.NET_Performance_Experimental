以下書籍の和訳書のハンズオン  
https://www.manning.com/books/unit-testing

---

## [メモ]

## なぜ、単体テストを行うのか？

- コードベースの秩序を維持・改善するために必要
- プロジェクトの成長を維持するために必要
- 品質に貢献する価値あるテストのみを行う
- 網羅率に固執して時間を浪費しないこと
- 優れたテストスイートは開発サイクルの中で自然に行われる(コンパイルエラーのようなもの)

---

## 単体テストとは何か？

- 単体テストとは以下の 3 つの性質を持ったテスト
  - 1 単位の振る舞いを検証すること
  - 実行時間が短いこと
  - 他のテストケースから隔離された状態で実行されること
- 統合テストとは、上記 3 つの性質の 1 つでも損なっているテスト

* E2E テストは統合テストの 1 種。全てのプロセス外依存を使うテストする

---

- 単体テストには、ロンドン学派と古典学派の２つの学派が存在する
  - ロンドン学派：単体とは 1 単位のコード(クラス)を指す。すべての不変依存をテストダブルに置き換える
  - 古典学派：単体とは 1 単位のテストケースを指す。他のテストケースに影響を与える可能性のある共有依存のみテストダブルに置き換える
    (※日本における TDD の第一人者は古典学派。基本的にモックは使わないにこしたことはないという考え。)

---

## 単体テストの構造

- 単体テストは １つの AAA パターン構造のみにすると保守性が向上する
  - 準備(Arrange)
  - 実行(Act)
  - 確認(Assert)

* 実行フェーズが 1 行ではない場合、テスト対象 API の設計が誤っている可能性が高い。

* テストの可読性を上げるため、テスト対象システム(System Under Test)のオブジェクト名を「sut」で統一すること。

* テストコードの共有にコンストラクタは使用しないこと。  
  インスタンスの準備にはファクトリー関数を用意する等。

* テストメソッドの命名は以下に従うと良い。

  - 厳密な命名規則を付けないこと
  - 単語はアンダースコアで区切ること
  - 非開発者にもわかるテストケース名にすること

* パラメータ化テストは汎用的にしすぎるとテストシナリオが分かりにくくなるため、乱用しないように注意が必要

---

## 良い単体テストを構成する 4 本の柱

- 退行に対する保護
- リファクタリングへの耐性
- 迅速なフィードバック
- 保守のしやすさ

※保守のしやすさ以外は背反する性質であるため、全てを完全にするのは不可能。テストピラミッドの層により重要度も変わる。

※テストを作成する際はブラックボックス視点。テストを分析する際にはホワイトボックス視点を持つこと。

---

- 最も質の高いテストである出力値ベースのテストを可能な限り導入する。

* 関数型アーキテクチャを採用すると保守性は向上するがパフォーマンスは犠牲になる。
* 対価が得られない場合は関数型アーキテクチャを採用する必要はない。
* プロセス外依存をドメイン・モデルに持ち込んではいけない。
* 副作用を起こす処理をビジネス・オペレーションの最後まで実行させないようにすることで単体テストを可能にする。

* 通常データベースはテスト対象アプリ以外からアクセスされることは稀なので、モックに置き換える必要がない場合がほとんど。

* 単体テストでは異常系を出来るだけ多く検証し、統合テストでは単体テストでカバーできない異常系と正常系を検証することでテストピラミッドが適切なバランスになりやすくなる。

---

[参考]  
[モックは必要悪で、しないにこしたことはない](https://blog.8-p.info/ja/2021/10/12/mock/)
